-- =============================================================================
-- DOMÍNIO: COMANDAS - VENDAFÁCIL BRASIL
-- VERSÃO: 5.0 (FIX: ALTER TABLE PARA COLUNAS FALTANTES)
-- =============================================================================

-- 0. GARANTIA DE ESTRUTURA (Previne erros se a tabela já existir sem a coluna)
-- -----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS public.comandas (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    store_id UUID NOT NULL REFERENCES public.stores(id) ON DELETE CASCADE,
    numero INTEGER NOT NULL,
    mesa TEXT,
    status TEXT NOT NULL DEFAULT 'aberta' CHECK (status IN ('aberta', 'aguardando_pagamento', 'fechada')),
    total_cents INTEGER DEFAULT 0,
    forma_pagamento TEXT CHECK (forma_pagamento IN ('dinheiro', 'pix', 'cartao')),
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Força a existência da coluna caso o IF NOT EXISTS acima tenha pulado a criação da tabela
ALTER TABLE public.comandas ADD COLUMN IF NOT EXISTS cliente_nome TEXT;

-- 1. LIMPEZA DE FUNÇÕES LEGADAS
-- -----------------------------------------------------------------------------
DROP FUNCTION IF EXISTS public.abrir_comanda(uuid, text);
DROP FUNCTION IF EXISTS public.abrir_comanda(uuid, text, text, text, text);
DROP FUNCTION IF EXISTS public.register_customer_on_table(uuid, text, text);
DROP FUNCTION IF EXISTS public.register_customer_on_table(uuid, text, text, text);
DROP FUNCTION IF EXISTS public.fechar_comanda(uuid, text);

-- 2. DADOS DE CLIENTES E VENDAS
-- -----------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS public.customers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    store_id UUID REFERENCES public.stores(id) ON DELETE CASCADE,
    comanda_id UUID REFERENCES public.comandas(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    phone TEXT,
    cpf TEXT,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 3. FUNÇÕES E PROCEDIMENTOS (RPCs)
-- -----------------------------------------------------------------------------

-- Função: Registrar Cliente
CREATE OR REPLACE FUNCTION public.register_customer_on_table(
    p_comanda_id UUID, 
    p_name TEXT, 
    p_phone TEXT,
    p_cpf TEXT DEFAULT NULL
) RETURNS BOOLEAN AS $$
DECLARE
    v_store_id UUID;
BEGIN
    SELECT store_id INTO v_store_id FROM public.comandas WHERE id = p_comanda_id;
    
    INSERT INTO public.customers (store_id, comanda_id, name, phone, cpf)
    VALUES (v_store_id, p_comanda_id, p_name, p_phone, p_cpf);
    
    RETURN TRUE;
EXCEPTION WHEN OTHERS THEN
    RETURN FALSE;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Função: Abrir Comanda
CREATE OR REPLACE FUNCTION public.abrir_comanda(
    p_store_id UUID, 
    p_mesa TEXT,
    p_cliente_nome TEXT DEFAULT NULL,
    p_cliente_telefone TEXT DEFAULT NULL,
    p_cliente_cpf TEXT DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
    v_numero INTEGER;
    v_comanda_id UUID;
BEGIN
    -- Numeração sequencial simples por loja
    SELECT COALESCE(MAX(numero), 0) + 1 INTO v_numero 
    FROM public.comandas 
    WHERE store_id = p_store_id;

    INSERT INTO public.comandas (store_id, numero, mesa, status, cliente_nome)
    VALUES (p_store_id, v_numero, p_mesa, 'aberta', p_cliente_nome)
    RETURNING id INTO v_comanda_id;

    -- Registro opcional no CRM
    IF p_cliente_nome IS NOT NULL THEN
        PERFORM public.register_customer_on_table(v_comanda_id, p_cliente_nome, p_cliente_telefone, p_cliente_cpf);
    END IF;

    RETURN v_comanda_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Função: Fechar Comanda
CREATE OR REPLACE FUNCTION public.fechar_comanda(
    p_comanda_id UUID, 
    p_forma_pagamento TEXT
) RETURNS RECORD AS $$
DECLARE
    v_result RECORD;
BEGIN
    UPDATE public.comandas 
    SET status = 'fechada',
        forma_pagamento = p_forma_pagamento
    WHERE id = p_comanda_id
    RETURNING id, status, forma_pagamento INTO v_result;

    -- Sincroniza o método de pagamento nas vendas vinculadas
    UPDATE public.sales 
    SET payment_method = CASE 
        WHEN p_forma_pagamento = 'dinheiro' THEN 'cash'
        WHEN p_forma_pagamento = 'pix' THEN 'pix'
        WHEN p_forma_pagamento = 'cartao' THEN 'card'
        ELSE 'cash'
    END
    WHERE comanda_id = p_comanda_id;

    RETURN v_result;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 4. VIEWS DE MONITORAMENTO
-- -----------------------------------------------------------------------------

CREATE OR REPLACE VIEW public.v_comandas_totais AS
SELECT 
    c.id,
    c.store_id,
    c.numero,
    c.mesa,
    c.status,
    c.cliente_nome,
    COALESCE(SUM(s.total_cents), 0) AS total_cents
FROM public.comandas c
LEFT JOIN public.sales s ON c.id = s.comanda_id
GROUP BY c.id, c.store_id, c.numero, c.mesa, c.status, c.cliente_nome;

CREATE OR REPLACE VIEW public.v_painel_cozinha AS
SELECT 
    si.id AS item_id,
    c.id AS comanda_id,
    c.numero AS comanda_numero,
    c.mesa,
    si.product_name_snapshot AS produto,
    si.quantity AS qty,
    si.status,
    si.created_at,
    c.store_id
FROM public.sale_items si
JOIN public.sales s ON si.sale_id = s.id
JOIN public.comandas c ON s.comanda_id = c.id
WHERE si.destino_preparo = 'cozinha' AND si.status != 'pronto' AND c.status != 'fechada';

CREATE OR REPLACE VIEW public.v_painel_bar AS
SELECT 
    si.id AS item_id,
    c.id AS comanda_id,
    c.numero AS comanda_numero,
    c.mesa,
    si.product_name_snapshot AS produto,
    si.quantity AS qty,
    si.status,
    si.created_at,
    c.store_id
FROM public.sale_items si
JOIN public.sales s ON si.sale_id = s.id
JOIN public.comandas c ON s.comanda_id = c.id
WHERE si.destino_preparo = 'bar' AND si.status != 'pronto' AND c.status != 'fechada';

-- 5. PERMISSÕES
-- -----------------------------------------------------------------------------

GRANT EXECUTE ON FUNCTION public.abrir_comanda(uuid, text, text, text, text) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.register_customer_on_table(uuid, text, text, text) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.fechar_comanda(uuid, text) TO authenticated;

GRANT SELECT ON public.v_painel_cozinha TO authenticated;
GRANT SELECT ON public.v_painel_bar TO authenticated;
GRANT SELECT ON public.v_comandas_totais TO authenticated;
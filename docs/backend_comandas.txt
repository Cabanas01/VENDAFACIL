-- =============================================================================
-- DOMÍNIO: INFRAESTRUTURA DE COMANDAS E PRODUÇÃO - VENDAFÁCIL BRASIL
-- VERSÃO: 8.0 (Sincronização com Option 01 - RPC Prefixes)
-- =============================================================================

-- 1. LIMPEZA DE SEGURANÇA
DROP FUNCTION IF EXISTS public.rpc_add_item_to_comanda CASCADE;
DROP FUNCTION IF EXISTS public.rpc_close_comanda_to_sale CASCADE;
DROP FUNCTION IF EXISTS public.rpc_mark_order_item_done CASCADE;

-- 2. FUNÇÕES RPC (LÓGICA OPERACIONAL PADRONIZADA)

-- Função: Adicionar Item à Comanda
CREATE OR REPLACE FUNCTION public.rpc_add_item_to_comanda(
    p_comanda_id UUID,
    p_product_id UUID,
    p_quantity INTEGER,
    p_unit_price INTEGER DEFAULT NULL
) RETURNS VOID AS $$
DECLARE
    v_store_id UUID;
    v_prod_name TEXT;
    v_prod_price INTEGER;
    v_prod_target TEXT;
BEGIN
    -- Coleta dados do produto
    SELECT store_id, name, price_cents, production_target INTO v_store_id, v_prod_name, v_prod_price, v_prod_target 
    FROM public.products WHERE id = p_product_id;

    -- Usa o preço passado ou o preço atual do produto
    IF p_unit_price IS NOT NULL THEN
        v_prod_price := p_unit_price;
    END IF;

    -- Insere o item vinculado à comanda (Tabela order_items)
    INSERT INTO public.order_items (
        store_id, comanda_id, product_id, product_name_snapshot, 
        quantity, unit_price, line_total, status, destino_preparo
    ) VALUES (
        v_store_id, p_comanda_id, p_product_id, v_prod_name, 
        p_quantity, v_prod_price, (v_prod_price * p_quantity), 'pending', v_prod_target
    );

    -- Baixa estoque via RPC existente
    PERFORM public.decrement_stock(p_product_id, p_quantity);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Função: Marcar Item como Concluído
CREATE OR REPLACE FUNCTION public.rpc_mark_order_item_done(p_item_id UUID) RETURNS BOOLEAN AS $$
BEGIN
    UPDATE public.order_items SET status = 'done' WHERE id = p_item_id;
    RETURN TRUE;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Função: Fechar Comanda e Gerar Venda
CREATE OR REPLACE FUNCTION public.rpc_close_comanda_to_sale(
    p_comanda_id UUID, 
    p_payment_method_id TEXT,
    p_cash_register_id UUID DEFAULT NULL
) RETURNS JSONB AS $$
DECLARE
    v_store_id UUID;
    v_total INTEGER;
    v_sale_id UUID;
BEGIN
    -- 1. Obter dados da comanda
    SELECT store_id INTO v_store_id FROM public.comandas WHERE id = p_comanda_id;
    
    -- 2. Calcular total dos itens da comanda
    SELECT COALESCE(SUM(line_total), 0) INTO v_total FROM public.order_items WHERE comanda_id = p_comanda_id;

    -- 3. Criar a Venda
    INSERT INTO public.sales (store_id, comanda_id, total_cents, payment_method, cash_register_id)
    VALUES (v_store_id, p_comanda_id, v_total, p_payment_method_id::public.sales.payment_method, p_cash_register_id)
    RETURNING id INTO v_sale_id;

    -- 4. Vincular itens à venda e atualizar status
    UPDATE public.order_items 
    SET sale_id = v_sale_id, status = 'done'
    WHERE comanda_id = p_comanda_id;

    -- 5. Fechar Comanda
    UPDATE public.comandas 
    SET status = 'fechada'
    WHERE id = p_comanda_id;

    RETURN jsonb_build_object('success', true, 'sale_id', v_sale_id);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 3. PERMISSÕES
GRANT EXECUTE ON FUNCTION public.rpc_add_item_to_comanda TO authenticated;
GRANT EXECUTE ON FUNCTION public.rpc_mark_order_item_done TO authenticated;
GRANT EXECUTE ON FUNCTION public.rpc_close_comanda_to_sale TO authenticated;

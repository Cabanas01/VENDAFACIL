-- ======================================================
-- üõ†Ô∏è BACKEND DEFINITIVO: VENDAF√ÅCIL SAAS (REVISADO)
-- FOCO: BLINDAGEM DE COLUNAS GERADAS (line_total)
-- ======================================================

-- 1Ô∏è‚É£ FUN√á√ÉO: ADICIONAR ITEM √Ä COMANDA (Transacional)
-- line_total √© omitido pois √© GENERATED ALWAYS no banco.
CREATE OR REPLACE FUNCTION public.rpc_add_item_to_comanda(
    p_comanda_id UUID,
    p_product_id UUID,
    p_quantity NUMERIC,
    p_unit_price NUMERIC DEFAULT NULL
) RETURNS TEXT AS $$
DECLARE
    v_store_id UUID;
    v_prod_name TEXT;
    v_prod_target TEXT;
    v_final_price NUMERIC;
BEGIN
    -- 1. Obter dados do produto e da comanda
    SELECT store_id INTO v_store_id FROM public.comandas WHERE id = p_comanda_id;
    SELECT name, production_target INTO v_prod_name, v_prod_target FROM public.products WHERE id = p_product_id;
    
    -- 2. Resolver pre√ßo
    IF p_unit_price IS NULL OR p_unit_price = 0 THEN
        SELECT price_cents INTO v_final_price FROM public.products WHERE id = p_product_id;
    ELSE
        v_final_price := p_unit_price;
    END IF;

    -- 3. Inserir em order_items (REGRA: NUNCA INCLUIR line_total NO INSERT)
    INSERT INTO public.order_items (
        store_id, 
        comanda_id, 
        product_id, 
        product_name_snapshot,
        quantity, 
        unit_price, 
        status,
        destino_preparo
    ) VALUES (
        v_store_id, 
        p_comanda_id, 
        p_product_id, 
        v_prod_name,
        p_quantity, 
        v_final_price, 
        'pending',
        v_prod_target
    );

    -- 4. Baixa de estoque
    UPDATE public.products 
    SET stock_qty = stock_qty - p_quantity 
    WHERE id = p_product_id;

    RETURN 'Item adicionado com sucesso';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 2Ô∏è‚É£ FUN√á√ÉO: FECHAR COMANDA E GERAR VENDA (At√¥mica)
-- Utiliza SUM(line_total) para garantir precis√£o absoluta do c√°lculo do banco.
CREATE OR REPLACE FUNCTION public.rpc_close_comanda_to_sale(
    p_comanda_id UUID,
    p_payment_method_id TEXT,
    p_cash_register_id UUID DEFAULT NULL
) RETURNS JSONB AS $$
DECLARE
    v_total_cents NUMERIC;
    v_sale_id UUID;
    v_store_id UUID;
BEGIN
    -- 1. Obter dados
    SELECT store_id INTO v_store_id FROM public.comandas WHERE id = p_comanda_id;
    
    -- 2. Calcular total real dos itens (Usando a generated column line_total)
    SELECT COALESCE(SUM(line_total), 0) INTO v_total_cents 
    FROM public.order_items WHERE comanda_id = p_comanda_id AND status != 'canceled';

    -- 3. Criar a Venda
    INSERT INTO public.sales (
        store_id, comanda_id, total_cents, payment_method, cash_register_id
    ) VALUES (
        v_store_id, p_comanda_id, v_total_cents, p_payment_method_id, p_cash_register_id
    ) RETURNING id INTO v_sale_id;

    -- 4. Atualizar itens e comanda
    UPDATE public.order_items SET sale_id = v_sale_id, status = 'done' WHERE comanda_id = p_comanda_id;
    UPDATE public.comandas SET status = 'fechada' WHERE id = p_comanda_id;

    RETURN jsonb_build_object('success', true, 'sale_id', v_sale_id);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
